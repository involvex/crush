<!DOCTYPE html>
<html>
<head>
    <title>Crush Web Interface</title>
    <style>
        body {
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #282a36; /* Dracula background */
            color: #f8f8f2; /* Dracula foreground */
        }
        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #44475a; /* Darker border */
        }
        #messages div {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        #messages strong {
            color: #50fa7b; /* Green for sender */
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #383a59; /* Slightly lighter dark for input area */
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #6272a4; /* Dracula comment color for border */
            border-radius: 4px;
            background-color: #44475a; /* Darker input background */
            color: #f8f8f2; /* Light text */
            font-family: monospace;
            font-size: 1em;
        }
        #message-input::placeholder {
            color: #bd93f9; /* Dracula purple for placeholder */
        }
        #send-button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #bd93f9; /* Dracula purple accent */
            color: #282a36; /* Dark text on button */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }
        #send-button:hover {
            background-color: #ff79c6; /* Dracula pink on hover */
        }
        .message-button { /* Styling for interactive command/model buttons */
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 5px 10px;
            background-color: #6272a4; /* Dracula comment color */
            color: #f8f8f2; /* Light text */
            border: 1px solid #44475a;
            border-radius: 3px;
            cursor: pointer;
            font-family: monospace;
            font-size: 0.9em;
        }
        .message-button:hover {
            background-color: #8be9fd; /* Dracula cyan on hover */
            color: #282a36;
        }
        #hud-container {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #44475a; /* Darker background for HUD */
            border-bottom: 1px solid #6272a4;
            font-size: 0.9em;
        }
        #hud-container div {
            padding: 5px 10px;
            border-radius: 3px;
            background-color: #282a36;
            color: #f8f8f2;
        }
        #hud-model { color: #ffb86c; } /* Dracula orange */
        #hud-cwd { color: #50fa7b; } /* Dracula green */
        #hud-tokens { color: #bd93f9; } /* Dracula purple */
        #hud-cpu { color: #ff79c6; } /* Dracula pink */
        #hud-mem { color: #f1fa8c; } /* Dracula yellow */
    </style>
</head>
<body>
    <div id="hud-container">
        <div id="hud-model">Model: N/A</div>
        <div id="hud-cwd">CWD: N/A</div>
        <div id="hud-tokens">Tokens: P:0 C:0 T:0</div>
        <div id="hud-cpu">CPU: N/A</div>
        <div id="hud-mem">Mem: N/A</div>
    </div>
    <div id="chat-container">
        <div id="messages"></div>
    </div>
    <div id="input-container">
        <input type="text" id="message-input" placeholder="Type your message or command...">
        <button id="send-button">Send</button>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const hudModelDiv = document.getElementById('hud-model');
        const hudCwdDiv = document.getElementById('hud-cwd');
        const hudTokensDiv = document.getElementById('hud-tokens');
        const hudCpuDiv = document.getElementById('hud-cpu');
        const hudMemDiv = document.getElementById('hud-mem');
        const ws = new WebSocket('ws://' + window.location.host + '/ws');

        let currentSessionId = null;

        ws.onopen = () => {
            console.log('WebSocket connected');
            // Initial message is now sent from the backend with session ID and HUD data
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'system' && data.sessionId) {
                currentSessionId = data.sessionId;
                appendMessage(data.sender, data.content);
                updateHUD(data); // Update HUD with initial data
            } else if (data.type === 'hudUpdate') {
                updateHUD(data);
            } else {
                appendMessage(data.sender, data.content);
            }
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            appendMessage('System', 'Disconnected from Crush AI.');
            currentSessionId = null;
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            appendMessage('System', 'WebSocket error: ' + error.message);
        };

        sendButton.onclick = sendMessage;
        messageInput.onkeydown = (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        };

        function sendMessage() {
            const content = messageInput.value;
            if (content.trim() === '') return;

            appendMessage('You', content);
            
            let messageToSend;
            if (content.startsWith('/')) {
                const parts = content.split(' ');
                const command = parts[0];
                const args = parts.slice(1);
                messageToSend = { type: 'command', command: command, args: args, sessionId: currentSessionId };
            } else {
                messageToSend = { type: 'message', content: content, sessionId: currentSessionId };
            }

            ws.send(JSON.stringify(messageToSend));
            messageInput.value = '';
        }

        function appendMessage(sender, content) {
            const messageElement = document.createElement('div');
            if (sender === 'System' && content.startsWith('Available commands:')) {
                messageElement.innerHTML = `<strong>${sender}:</strong> `;
                const commandsText = content.replace('Available commands: ', '');
                const commands = commandsText.split(', ').map(cmd => cmd.trim());
                
                commands.forEach(cmd => {
                    const button = document.createElement('button');
                    button.textContent = cmd;
                    button.classList.add('message-button'); // Add class for styling
                    button.onclick = () => {
                        messageInput.value = cmd;
                        messageInput.focus();
                    };
                    messageElement.appendChild(button);
                });
            } else if (sender === 'System' && content.startsWith('Available models:')) {
                messageElement.innerHTML = `<strong>${sender}:</strong> `;
                const modelsText = content.replace('Available models:\n', '');
                const models = modelsText.split('\n').filter(line => line.trim() !== '');
                
                models.forEach(modelLine => {
                    const match = modelLine.match(/^- (.+) \(Provider: (.+)\)$/);
                    if (match) {
                        const modelName = match[1];
                        const providerName = match[2];
                        const button = document.createElement('button');
                        button.textContent = `${modelName} (Provider: ${providerName})`;
                        button.classList.add('message-button'); // Add class for styling
                        button.onclick = () => {
                            messageInput.value = `/model ${modelName}`;
                            messageInput.focus();
                        };
                        messageElement.appendChild(button);
                    }
                });
            } else {
                messageElement.innerHTML = `<strong>${sender}:</strong> ${content}`;
            }
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll to bottom
        }

        function updateHUD(data) {
            if (data.currentModel) {
                hudModelDiv.textContent = `Model: ${data.currentModel}`;
            }
            if (data.cwd) {
                hudCwdDiv.textContent = `CWD: ${data.cwd}`;
            }
            if (data.promptTokens !== undefined && data.completionTokens !== undefined && data.totalTokens !== undefined) {
                hudTokensDiv.textContent = `Tokens: P:${data.promptTokens} C:${data.completionTokens} T:${data.totalTokens}`;
            }
            if (data.cpuUsage !== undefined) {
                hudCpuDiv.textContent = `CPU: ${data.cpuUsage.toFixed(1)}%`;
            }
            if (data.memUsedMB !== undefined && data.memTotalMB !== undefined) {
                hudMemDiv.textContent = `Mem: ${data.memUsedMB}MB / ${data.memTotalMB}MB (${data.memUsage.toFixed(1)}%)`;
            }
        }
    </script>
</body>
</html>